<pcr-un-have-chara [serverType]="serverType"></pcr-un-have-chara>

<div class="g-card" style="margin-top: 16px">
  <h3 class="g-card-title">工会战作业查询</h3>
  <nz-spin [nzSpinning]="isSpinning" nzTip="正在加载数据">
    <form nz-form class="form">
      <nz-form-item>
        <nz-form-label nzTooltipTitle="图片显示不出切换为oss"
          >图源</nz-form-label
        >
        <nz-form-control>
          <nz-select
            [(ngModel)]="imgSource"
            (ngModelChange)="toggleImgSource($event)"
            name="imgSource"
            nzPlaceHolder="请选择"
            style="min-width: 90px"
          >
            <nz-option
              *ngFor="let item of imgSourceOption"
              [nzValue]="item.value"
              [nzLabel]="item.label"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>服务器</nz-form-label>
        <nz-form-control>
          <nz-select
            [(ngModel)]="serverType"
            name="serverType"
            [nzDisabled]="operate"
            (ngModelChange)="toggleServer()"
          >
            <nz-option
              *ngFor="let item of serverOption"
              [nzLabel]="item.label"
              [nzValue]="item.value"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>期次</nz-form-label>
        <nz-form-control>
          <nz-select
            [(ngModel)]="clanBattleId"
            (ngModelChange)="battleIdChange($event)"
            style="min-width: 110px"
            name="clanBattleId"
          >
            <nz-option
              *ngFor="let item of clanBattleList"
              [nzValue]="item.clanBattleId"
              [nzLabel]="item.startTime | date: 'yyyy/MM'"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>阶段</nz-form-label>
        <nz-form-control>
          <nz-select
            [(ngModel)]="stage"
            name="stage"
            nzPlaceHolder="请选择"
            style="min-width: 90px"
          >
            <nz-option
              *ngFor="let item of stageOption"
              [nzValue]="item.value"
              [nzLabel]="item.label"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzTooltipTitle="筛选尾刀/已使用/已去除"
          >类别</nz-form-label
        >
        <nz-form-control>
          <nz-select
            [(ngModel)]="taskType"
            (ngModelChange)="toggleAutoBoss()"
            nzMode="multiple"
            name="taskType"
            style="min-width: 90px"
          >
            <nz-option nzValue="all" nzLabel="全部"></nz-option>
            <nz-option nzValue="used" nzLabel="已使用"></nz-option>
            <nz-option nzValue="removed" nzLabel="已去除"></nz-option>
            <nz-option nzValue="tail" nzLabel="尾刀"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>自动</nz-form-label>
        <nz-form-control>
          <nz-select
            [(ngModel)]="autoSetting"
            (ngModelChange)="toggleAutoBoss()"
            nzMode="multiple"
            name="autoSetting"
            nzPlaceHolder="请选择"
            style="min-width: 80px"
          >
            <nz-option
              *ngFor="let item of autoOption"
              [nzValue]="item.value"
              [nzLabel]="item.label"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>BOSS</nz-form-label>
        <nz-form-control>
          <nz-select
            [(ngModel)]="bossNumberList"
            (ngModelChange)="toggleAutoBoss()"
            nzMode="multiple"
            name="boss"
            nzPlaceHolder="请选择"
            style="min-width: 90px"
          >
            <nz-option [nzValue]="1" nzLabel="1"></nz-option>
            <nz-option [nzValue]="2" nzLabel="2"></nz-option>
            <nz-option [nzValue]="3" nzLabel="3"></nz-option>
            <nz-option [nzValue]="4" nzLabel="4"></nz-option>
            <nz-option [nzValue]="5" nzLabel="5"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <div class="g-flex form-action">
        <div>
          <button (clickStop)="openNotice()" class="g-btn-danger" nz-button>
            查看公告
          </button>
          <button (clickStop)="openAll()" class="g-btn" nz-button>
            展开所有
          </button>
          <button (clickStop)="closeAll()" class="g-btn" nz-button>
            关闭所有
          </button>
        </div>

        <div class="g-flex">
          <button
            class="g-btn"
            nz-button
            [nzLoading]="searchLoading"
            (clickStop)="getGvgTaskList()"
          >
            搜索
          </button>
          <button
            (clickStop)="addTask()"
            *ngIf="operate"
            class="g-btn"
            nz-button
          >
            添加作业
          </button>
          <button
            (clickStop)="updateCnTask()"
            [nzLoading]="updateCnTaskLoading"
            *ngIf="operate && serverType === 'cn'"
            class="g-btn"
            nz-button
          >
            更新作业
          </button>
          <button
            class="g-btn filter"
            [nzLoading]="filterLoading"
            nz-button
            (clickStop)="filter()"
          >
            分刀
          </button>
        </div>
      </div>
    </form>
  </nz-spin>

  <pcr-billboard
    *ngIf="!filterGvgTaskList.length"
    [serverType]="serverType"
    [content]="notice?.content"
    [showLink]="showLink"
  ></pcr-billboard>

  <nz-collapse  [nzBordered]="false" nzExpandIconPosition="right">
    <nz-collapse-panel
      #collapse
      [nzActive]="true"
      class="custom-panel"
      *ngFor="let bossTask of filterGvgTaskList; trackBy: trackByBossFn"
      [nzHeader]="headerTpl"
    >
      <ng-template #headerTpl>
        <div class="g-flex-between">
          <div class="g-flex" style="align-items: center">
            <pcr-icon style="margin: 0 40px" [unit]="bossTask">
            </pcr-icon>
            <div>{{ bossTask.unitName }}</div>
          </div>
        </div>
      </ng-template>

      <div *ngIf="bossTask.tasks.length">
        <nz-collapse [nzBordered]="false" nzExpandIconPosition="right">
          <nz-collapse-panel
            [nzActive]="false"
            style="
              border-top: 1px solid #64b8ff;
              background: rgba(255, 255, 255, 0.5);
            "
            *ngFor="let task of bossTask.tasks; trackBy: trackByTaskFn"
            [nzHeader]="childHeaderTpl"
          >
            <ng-template #childHeaderTpl>
              <pcr-task-item
                [task]="task"
                [usedList]="usedList"
                [removedList]="removedList"
                [operate]="operate"
                [serverType]="serverType"
                (onAddTask)="addTask($event, bossTask.id)"
                (onDelete)="onTaskDelete($event, bossTask)"
              ></pcr-task-item>
            </ng-template>


            <div *ngIf="task.remarks" class="g-card" style="margin: 16px 0;">
              <h6>备注: </h6>
              <pre>{{ task.remarks }}</pre>
            </div>
            <div class="g-card">
              <nz-tabset *ngIf="task.links.length; else elseLInkTpe">
                <nz-tab [nzTitle]="linkObj.name" *ngFor="let linkObj of task.links"  >
                  <div *ngIf="linkObj.link">
                    视频连接: <a target="_blank" [href]="linkObj.link">{{ linkObj.name }}</a>
                  </div>
                  <div *ngIf="linkObj.remarks" >
                    <h6>备注:</h6>
                    <pre >{{ linkObj.remarks }}</pre>
                  </div>
                </nz-tab>
              </nz-tabset>
      
              <ng-template #elseLInkTpe>无视频连接</ng-template>
            </div>
          </nz-collapse-panel>
        </nz-collapse>
      </div>
    </nz-collapse-panel>
  </nz-collapse>
</div>
